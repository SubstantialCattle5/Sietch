#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Check if Go is installed
if ! command -v go >/dev/null 2>&1; then
    echo "âŒ Go is not installed or not in PATH"
    exit 1
fi

# Get the remote and branch being pushed to
remote="$1"
url="$2"

echo "ğŸ“¡ Pushing to: $remote ($url)"

# Run all tests including integration tests
echo "ğŸ§ª Running comprehensive tests..."
if ! make test; then
    echo "âŒ Tests failed. Please fix failing tests before pushing."
    echo "ğŸ’¡ Run 'make test' to see detailed test results"
    exit 1
fi
echo "âœ… All tests passed"

# Build check
echo "ğŸ”¨ Verifying build..."
if ! make build; then
    echo "âŒ Build failed. Please fix build issues before pushing."
    echo "ğŸ’¡ Run 'make build' to see build errors"
    exit 1
fi
echo "âœ… Build successful"

# Security audit (if available)
if command -v gosec >/dev/null 2>&1; then
    echo "ğŸ”’ Running security audit..."
    if ! make security-audit; then
        echo "âš ï¸  Security audit found issues, but not blocking push"
        echo "ğŸ’¡ Review security findings and consider fixing them"
    else
        echo "âœ… Security audit passed"
    fi
else
    echo "âš ï¸  gosec not found, skipping security audit"
fi

# Check for any uncommitted changes that might affect the build
if ! git diff --quiet; then
    echo "âš ï¸  Warning: You have uncommitted changes"
    echo "ğŸ’¡ Consider committing all changes before pushing"
fi

echo "ğŸ‰ All pre-push checks passed! Ready to push."
